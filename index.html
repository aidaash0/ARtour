<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Portal Experience</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe-ar.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }
        
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .ui-panel {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            pointer-events: auto;
            text-align: center;
            max-width: 300px;
        }
        
        .status-panel {
            background: rgba(0, 50, 100, 0.9);
        }
        
        .instruction-panel {
            background: rgba(50, 50, 50, 0.9);
            font-size: 14px;
        }
        
        .ar-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .ar-button:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        .ar-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .device-warning {
            background: rgba(255, 100, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="ui-overlay">
        <div class="ui-panel status-panel">
            <div id="status-text">Initializing AR Portal...</div>
            <div id="device-info"></div>
        </div>
        
        <div class="ui-panel instruction-panel">
            <p>ðŸšª Point your camera at a flat surface</p>
            <p>ðŸ‘† Tap to place the portal door</p>
            <p>ðŸš¶ Walk through the door to enter</p>
            <button id="start-ar-btn" class="ar-button" disabled>Start AR Experience</button>
        </div>
    </div>

    <a-scene 
        id="ar-scene"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">
        
        <!-- Assets -->
        <a-assets>
            <a-asset-item id="room-model-glb" src="modelglb.glb"></a-asset-item>
            <a-asset-item id="room-model-usdz" src="modelusdz.usdz"></a-asset-item>
        </a-assets>
        
        <!-- Outer Scene (Real World) -->
        <a-entity id="outer-scene">
            <!-- AR Camera -->
            <a-camera 
                id="ar-camera"
                look-controls="enabled: false"
                wasd-controls="enabled: false"
                position="0 1.6 0">
                
                <!-- Reticle for placement -->
                <a-ring 
                    id="reticle"
                    radius-inner="0.02"
                    radius-outer="0.03"
                    color="#ffffff"
                    opacity="0.8"
                    position="0 0 -2"
                    visible="false">
                </a-ring>
            </a-camera>
            
            <!-- Portal Frame (Initially hidden) -->
            <a-entity 
                id="portal-frame"
                visible="false"
                portal-controller
                position="0 0 -3">
                
                <!-- Portal Door Frame -->
                <a-box 
                    id="door-frame"
                    width="2.2"
                    height="3"
                    depth="0.1"
                    color="#8B4513"
                    material="roughness: 0.8; metalness: 0.2"
                    position="0 1.5 0">
                    
                    <!-- Door opening (invisible but acts as trigger) -->
                    <a-box 
                        id="door-opening"
                        width="1.8"
                        height="2.6"
                        depth="0.2"
                        material="opacity: 0; transparent: true"
                        position="0 0 0"
                        portal-trigger>
                    </a-box>
                </a-box>
                
                <!-- Portal stencil mask -->
                <a-plane 
                    id="portal-mask"
                    width="1.8"
                    height="2.6"
                    position="0 1.5 0.05"
                    material="shader: portal-stencil; transparent: true; opacity: 0"
                    visible="false">
                </a-plane>
            </a-entity>
        </a-entity>
        
        <!-- Inner Scene (Portal World) - Initially hidden -->
        <a-entity 
            id="inner-scene"
            visible="false"
            position="0 0 -50">
            
            <!-- Room Model -->
            <a-entity 
                id="room-model"
                room-loader
                scale="1 1 1"
                position="0 0 0">
            </a-entity>
            
            <!-- Interior lighting -->
            <a-light 
                type="ambient"
                intensity="0.4"
                color="#ffffff">
            </a-light>
            
            <a-light 
                type="directional"
                intensity="0.8"
                position="2 4 2"
                color="#ffffff">
            </a-light>
            
            <a-light 
                type="point"
                intensity="0.5"
                position="0 2 0"
                color="#ffaa77">
            </a-light>
        </a-entity>
        
        <!-- AR Marker (fallback) -->
        <a-marker 
            id="ar-marker"
            preset="hiro"
            smooth="true"
            smoothCount="10"
            smoothTolerance="0.01"
            smoothThreshold="5">
        </a-marker>
    </a-scene>

    <script>
        // Device detection and model loading
        class ARPortalApp {
            constructor() {
                this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                this.isAndroid = /Android/.test(navigator.userAgent);
                this.scene = document.querySelector('#ar-scene');
                this.camera = document.querySelector('#ar-camera');
                this.portalFrame = document.querySelector('#portal-frame');
                this.innerScene = document.querySelector('#inner-scene');
                this.reticle = document.querySelector('#reticle');
                this.isPortalPlaced = false;
                this.isInPortal = false;
                this.userPosition = new THREE.Vector3();
                this.portalPosition = new THREE.Vector3();
                
                this.init();
            }
            
            init() {
                this.updateDeviceInfo();
                this.setupEventListeners();
                this.setupARComponents();
                this.startARSession();
            }
            
            updateDeviceInfo() {
                const deviceInfo = document.getElementById('device-info');
                const platform = this.isIOS ? 'iOS' : this.isAndroid ? 'Android' : 'Desktop';
                const modelFormat = this.isIOS ? 'USDZ' : 'GLB';
                
                deviceInfo.innerHTML = `
                    <div class="device-warning">
                        Platform: ${platform}<br>
                        Model Format: ${modelFormat}
                    </div>
                `;
            }
            
            setupEventListeners() {
                const startBtn = document.getElementById('start-ar-btn');
                startBtn.addEventListener('click', () => this.startARExperience());
                
                // Touch/click events for portal placement
                this.scene.addEventListener('click', (e) => this.handleSceneClick(e));
                
                // Camera position tracking
                this.camera.addEventListener('componentchanged', (e) => {
                    if (e.detail.name === 'position') {
                        this.updateUserPosition();
                    }
                });
            }
            
            setupARComponents() {
                // Portal Controller Component
                AFRAME.registerComponent('portal-controller', {
                    init: function() {
                        this.el.addEventListener('click', () => {
                            app.placePortal(this.el.object3D.position);
                        });
                    }
                });
                
                // Room Loader Component
                AFRAME.registerComponent('room-loader', {
                    init: function() {
                        this.loadRoomModel();
                    },
                    
                    loadRoomModel: function() {
                        const loader = new THREE.GLTFLoader();
                        const modelPath = app.isIOS ? 'room.usdz' : 'room.glb';
                        
                        // For iOS, we need to handle USDZ differently
                        if (app.isIOS) {
                            this.loadUSDZModel(modelPath);
                        } else {
                            this.loadGLBModel(modelPath);
                        }
                    },
                    
                    loadGLBModel: function(path) {
                        const loader = new THREE.GLTFLoader();
                        loader.load(
                            path,
                            (gltf) => {
                                console.log('GLB model loaded successfully');
                                this.el.setObject3D('mesh', gltf.scene);
                                this.processRoomModel(gltf.scene);
                            },
                            (progress) => {
                                console.log('Loading progress:', progress);
                            },
                            (error) => {
                                console.error('Error loading GLB model:', error);
                                this.createFallbackRoom();
                            }
                        );
                    },
                    
                    loadUSDZModel: function(path) {
                        // For USDZ, we create a fallback since direct loading in browser is limited
                        console.log('iOS detected - creating fallback room');
                        this.createFallbackRoom();
                    },
                    
                    processRoomModel: function(model) {
                        // Find and configure the door in the model
                        model.traverse((child) => {
                            if (child.isMesh) {
                                // Look for door-related objects
                                if (child.name.toLowerCase().includes('door')) {
                                    child.userData.isDoor = true;
                                }
                                
                                // Set up materials for portal effect
                                if (child.material) {
                                    child.material.side = THREE.DoubleSide;
                                }
                            }
                        });
                    },
                    
                    createFallbackRoom: function() {
                        console.log('Creating fallback room geometry');
                        const roomGroup = new THREE.Group();
                        
                        // Create room walls
                        const wallGeometry = new THREE.PlaneGeometry(8, 4);
                        const wallMaterial = new THREE.MeshLambertMaterial({ 
                            color: 0xdddddd,
                            side: THREE.DoubleSide 
                        });
                        
                        // Back wall
                        const backWall = new THREE.Mesh(wallGeometry, wallMaterial);
                        backWall.position.set(0, 2, -4);
                        roomGroup.add(backWall);
                        
                        // Side walls
                        const leftWall = new THREE.Mesh(wallGeometry, wallMaterial);
                        leftWall.rotation.y = Math.PI / 2;
                        leftWall.position.set(-4, 2, 0);
                        roomGroup.add(leftWall);
                        
                        const rightWall = new THREE.Mesh(wallGeometry, wallMaterial);
                        rightWall.rotation.y = -Math.PI / 2;
                        rightWall.position.set(4, 2, 0);
                        roomGroup.add(rightWall);
                        
                        // Floor
                        const floorGeometry = new THREE.PlaneGeometry(8, 8);
                        const floorMaterial = new THREE.MeshLambertMaterial({ 
                            color: 0x8B4513,
                            side: THREE.DoubleSide 
                        });
                        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                        floor.rotation.x = -Math.PI / 2;
                        floor.position.set(0, 0, 0);
                        roomGroup.add(floor);
                        
                        // Ceiling
                        const ceiling = new THREE.Mesh(floorGeometry, wallMaterial);
                        ceiling.rotation.x = Math.PI / 2;
                        ceiling.position.set(0, 4, 0);
                        roomGroup.add(ceiling);
                        
                        // Add some furniture
                        const furnitureGeometry = new THREE.BoxGeometry(1, 1, 1);
                        const furnitureMaterial = new THREE.MeshLambertMaterial({ color: 0x654321 });
                        
                        const table = new THREE.Mesh(furnitureGeometry, furnitureMaterial);
                        table.position.set(0, 0.5, -2);
                        roomGroup.add(table);
                        
                        const chair = new THREE.Mesh(furnitureGeometry, furnitureMaterial);
                        chair.position.set(-2, 0.5, -1);
                        chair.scale.set(0.5, 1, 0.5);
                        roomGroup.add(chair);
                        
                        this.el.setObject3D('mesh', roomGroup);
                    }
                });
                
                // Portal Trigger Component
                AFRAME.registerComponent('portal-trigger', {
                    init: function() {
                        this.el.addEventListener('triggerenter', () => {
                            app.enterPortal();
                        });
                    }
                });
                
                // Portal Stencil Shader
                AFRAME.registerShader('portal-stencil', {
                    schema: {},
                    init: function() {
                        this.material = new THREE.MeshBasicMaterial({
                            colorWrite: false,
                            depthWrite: false,
                            transparent: true
                        });
                    }
                });
            }
            
            startARSession() {
                document.getElementById('status-text').textContent = 'AR Session Starting...';
                
                // Enable AR button after scene is ready
                this.scene.addEventListener('loaded', () => {
                    document.getElementById('start-ar-btn').disabled = false;
                    document.getElementById('start-ar-btn').textContent = 'Start AR Experience';
                    document.getElementById('status-text').textContent = 'Ready for AR';
                });
            }
            
            startARExperience() {
                document.getElementById('status-text').textContent = 'AR Active - Find a surface';
                this.reticle.setAttribute('visible', true);
                
                // Start AR tracking
                this.scene.enterAR();
            }
            
            handleSceneClick(event) {
                if (!this.isPortalPlaced) {
                    const intersection = event.detail.intersection;
                    if (intersection) {
                        this.placePortal(intersection.point);
                    }
                }
            }
            
            placePortal(position) {
                if (this.isPortalPlaced) return;
                
                this.isPortalPlaced = true;
                this.portalPosition.copy(position);
                
                // Position and show portal frame
                this.portalFrame.setAttribute('position', 
                    `${position.x} ${position.y + 1.5} ${position.z}`);
                this.portalFrame.setAttribute('visible', true);
                
                // Hide reticle
                this.reticle.setAttribute('visible', false);
                
                // Update UI
                document.getElementById('status-text').textContent = 'Portal Placed - Walk through the door';
                
                // Start proximity detection
                this.startProximityDetection();
            }
            
            startProximityDetection() {
                setInterval(() => {
                    if (this.isPortalPlaced && !this.isInPortal) {
                        this.checkPortalProximity();
                    }
                }, 100);
            }
            
            checkPortalProximity() {
                const distance = this.userPosition.distanceTo(this.portalPosition);
                
                if (distance < 1.5) { // Close enough to portal
                    this.enterPortal();
                }
            }
            
            enterPortal() {
                if (this.isInPortal) return;
                
                this.isInPortal = true;
                document.getElementById('status-text').textContent = 'Entering Portal...';
                
                // Animate transition
                this.animatePortalTransition();
            }
            
            animatePortalTransition() {
                // Fade out outer scene
                this.scene.emit('fade-out');
                
                setTimeout(() => {
                    // Hide outer scene, show inner scene
                    document.querySelector('#outer-scene').setAttribute('visible', false);
                    this.innerScene.setAttribute('visible', true);
                    
                    // Position camera in room
                    this.camera.setAttribute('position', '0 1.6 3');
                    this.camera.setAttribute('look-controls', 'enabled: true');
                    this.camera.setAttribute('wasd-controls', 'enabled: true');
                    
                    // Update UI
                    document.getElementById('status-text').textContent = 'Welcome to the Portal World!';
                    
                    // Fade in inner scene
                    this.scene.emit('fade-in');
                }, 1000);
            }
            
            updateUserPosition() {
                const pos = this.camera.getAttribute('position');
                this.userPosition.set(pos.x, pos.y, pos.z);
            }
        }
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new ARPortalApp();
        });
        
        // Handle AR session events
        document.addEventListener('ar-session-started', () => {
            console.log('AR session started');
        });
        
        document.addEventListener('ar-session-ended', () => {
            console.log('AR session ended');
        });
    </script>
</body>
</html>
